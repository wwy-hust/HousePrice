# 房价信息展示网站

这是一个展示70个大中城市房价信息的网站项目。

## 功能特性

- 从国家统计局获取房价数据
- 展示70个大中城市的新建商品住宅和二手住宅销售价格指数
- 提供数据分析和可视化功能
- **全新Web可视化界面**：提供交互式图表展示房价指数变化趋势
- **多维度数据展示**：支持基础指数和分类指数（按面积分类）
- **实时图表更新**：选择不同城市和指标时动态更新图表
- **统计信息展示**：显示数据统计摘要和趋势分析
- 自动去除城市名中间的空格（如"北 京" → "北京"，"唐 山" → "唐山"）
- 智能识别并清理所有包含城市名的列中的空格
- 自动提取并记录表格标题信息（从表格上方的"表X："格式标题获取）
- 在XML中添加表格标题和名称属性（title和name属性）
- 表格标题格式："表X：XXXXX指数"，名称为"XXXXX指数"部分
- 智能识别表头行：将不包含城市名称的行标记为`<head>`标签
- 数据行使用`<row>`标签，表头行使用`<head>`标签进行区分
- 智能合并同名表格：相同表名的表格会自动合并，只保留一份表头
- 表格去重：原始12个表格合并为4个逻辑表格，避免数据重复
- 优化XML结构：表头从data中独立出来，去除冗余的columns元素
- 清晰的数据层次：table -> head + data 的简洁结构
- 表1和表2特殊处理：head只保留前4个cell，数据行拆分（8列变4列两行）
- 智能行索引重排：表1和表2的数据行从0开始重新编号
- 表1和表2表头合并：将两行表头合并为一行，相同内容去重，不同内容拼接
- 表3和表4表头合并：将三行表头合并为一行，智能组合面积类型+指标类型+计算基准
- 全表数据行重编号：所有表格的数据行索引都从0开始重新编号

## 数据来源

数据来自国家统计局，包含四个表格：
1. 70个大中城市新建商品住宅销售价格指数
2. 70个大中城市二手住宅销售价格指数  
3. 70个大中城市新建商品住宅销售价格分类指数
4. 70个大中城市二手住宅销售价格分类指数

## 项目结构

```
HousePrice/
├── README.md                 # 项目说明文档
├── requirements.txt          # Python依赖包
├── web_server.py            # Web可视化服务器
├── web/                     # Web界面文件
│   ├── index.html          # Web界面主页
│   ├── style.css           # 界面样式文件
│   └── app.js              # 前端JavaScript代码
├── results/                 # 处理后的数据文件
│   ├── new_house_basic_index.json
│   ├── used_house_basic_index.json
│   ├── new_house_classified_*.json
│   ├── used_house_classified_*.json
│   └── summary_report.json
├── data_collector.py        # 数据采集模块
├── city_price_processor.py  # 城市房价指数处理脚本
├── batch_process_all_cities.py # 批量处理所有城市数据
├── url_collector_api.py     # URL采集API
├── HousePriceURL.csv        # 数据源URL列表
└── collected_data/          # 采集的数据存储目录
    ├── house_price_data_2020_11_16.xml
    ├── house_price_data_2020_12_14.xml
    └── ... (更多XML数据文件)
```

## 安装和运行

### Web可视化界面（推荐）

1. 确保已有数据文件：
```bash
# 如果没有results目录的数据，先运行数据处理
python city_price_processor.py
```

2. 启动Web可视化服务器：
```bash
python web_server.py
```

3. 访问应用：
在浏览器中打开 http://localhost:8000

**Web界面功能：**
- 选择展示内容：基础指数 或 分类指数
- 选择城市：70个大中城市任选
- 选择指标：环比指数、同比指数
- 实时图表：折线图展示价格指数变化趋势
- 统计信息：数据摘要和极值分析

### 命令行参数

```bash
# 自定义主机和端口
python web_server.py --host 0.0.0.0 --port 9000
```

### 传统方式（如果存在）

1. 安装依赖：
```bash
pip install -r requirements.txt
```

2. 启动服务器：
```bash
python server.py  # 如果存在
```

### 数据采集（可选）

如果需要更新数据，可以运行数据采集脚本：
```bash
python data_collector.py
```

## Web界面使用说明

### 界面布局

Web界面分为两个主要部分：

**1. 控制面板（上方）**
- **展示内容选择**：4个互斥选项
  - 新建商品住宅销售价格指数
  - 二手住宅销售价格指数  
  - 新建商品住宅销售价格分类指数
  - 二手住宅销售价格分类指数
- **面积分类**：当选择分类指数时显示
  - 90平米以下
  - 90-144平米
  - 144平米以上
- **城市选择**：70个大中城市按拼音首字母排序，全部展开显示为单选框组
- **自动更新**：选择城市或更改选项时自动更新图表

**2. 图表展示区域（下方）**
- **折线图**：显示选定城市的实际价格指数变化趋势
- **交互式悬浮框**：点击数据点显示环比、同比指数和月增长率
- **统计信息**：显示数据摘要（数据点数量、时间范围、极值等）

### 操作流程

1. **选择展示内容**：点击选择基础指数或分类指数
2. **选择面积类型**：如果选了分类指数，再选择面积范围  
3. **选择城市**：从城市网格中点击要查看的城市
4. **自动更新**：选择城市或更改选项时图表会自动更新
5. **查看结果**：在图表中查看趋势，鼠标悬停查看详细数据

### 图表功能

- **实际价格指数显示**：基于累积增长率计算的绝对价格水平
- **交互式悬浮框**：鼠标悬停显示环比指数、同比指数和月增长率
- **时间轴**：X轴按时间顺序显示（从2020年11月开始）
- **智能数据源**：优先使用矫正后数据(corrected_result)，确保更高准确性
- **响应式设计**：适配不同屏幕尺寸

### 数据说明

- **实际价格指数**：基于环比数据累积计算的价格指数（100为基期）
- **环比指数**：与上月相比的价格变化（100为基准）
- **同比指数**：与去年同月相比的价格变化（100为基准）
- **月增长率**：当月实际增长百分比
- **时间范围**：2020年11月至最新数据
- **数据来源**：国家统计局官方发布数据，经过环比同比交叉验证矫正

## URL数据采集接口

### 基本使用

1. **使用数据采集器类**：
```python
from data_collector import HousePriceDataCollector

collector = HousePriceDataCollector()
success = collector.collect_single_url_data(
    url="https://www.stats.gov.cn/sj/zxfb/202508/t20250815_1960781.html",
    description="2025年7月份房价数据",
    date="2025-08-15"
)
```

2. **使用命令行接口**：
```bash
python url_collector_api.py "https://www.stats.gov.cn/sj/zxfb/202508/t20250815_1960781.html" -d "2025年7月份房价数据" -t "2025-08-15"
```

3. **批量采集**：
```python
# 从CSV文件加载URL列表并批量采集
collector = HousePriceDataCollector()
url_df = collector.load_url_list()
for index, row in url_df.iterrows():
    collector.collect_single_url_data(row['标题链接'], row['标题'], row['时间'])
```

### 数据格式

采集的数据以XML格式存储，包含以下结构：
- 根元素：`house_price_data`
- 属性：`source_url`, `description`, `date`, `collected_at`
- 子元素：多个`table`元素，每个表格包含：
  - 属性：`index`（表格序号）, `rows`（行数）, `columns`（列数）, `title`（完整表格标题）, `name`（表格名称）
  - 表头区域：`<head>`元素，包含表头行（列名行、单位说明行等）
  - 数据区域：`<data>`元素，包含数据行（城市名称和具体数据）
  - 所有城市名称已自动去除空格

### 验证数据

数据采集完成后，可以通过查看生成的XML文件来验证数据结构和内容的正确性。

## 项目文件说明

### 核心文件
- `data_collector.py` - 主要的数据采集器类
- `url_collector_api.py` - 命令行接口，用于单个URL数据采集

### 数据文件
- `HousePriceURL.csv` - 包含58个统计局URL的CSV文件
- `collected_data/` - 存储采集的XML数据文件

### 运行示例
```bash
# 采集单个URL
python url_collector_api.py "URL" -d "描述" -t "日期"
```

## 开发进度

- [x] 项目基础结构
- [x] URL数据采集接口
- [x] 数据解析和存储
- [x] 批量数据采集
- [x] 错误处理和日志记录
- [x] 使用示例和文档
- [x] 城市名空格自动去除功能（智能识别所有包含城市名的列）
- [x] 表格标题自动提取功能（支持"表X：XXXXX指数"格式）
- [x] XML中添加表格标题和名称属性（title和name属性）
- [x] 表格数据智能清理（去除城市名称中的空格）
- [x] 智能表头行识别（表头行使用`<head>`标签，数据行使用`<row>`标签）
- [x] 智能表格合并功能（同名表格自动合并，只保留一份表头）
- [x] XML结构优化（表头独立，去除columns元素，简化结构）
- [x] 表1和表2特殊优化（head去重复，数据行拆分重排）
- [x] 表1和表2表头智能合并（相同内容去重，不同内容拼接）
- [x] 表3和表4表头智能合并（三行合并为一行，完整语义表达）
- [x] 全表数据行索引规范化（所有表格数据行从0开始编号）
- [x] Web界面开发
- [x] 数据可视化

## Web可视化界面

### 功能特性

- **响应式设计**：适配桌面和移动设备
- **数据类型选择**：支持四种房价指数类型选择
- **城市多选**：可同时选择最多10个城市进行对比
- **智能分组**：按地区对70个大中城市进行分组展示
- **动态图表**：基于Chart.js的交互式线性图表
- **累积计算**：自动计算基于100的累积价格指数
- **时间序列**：按时间顺序展示价格变化趋势

### 界面布局

1. **顶部标题区域**：项目名称和描述
2. **控制面板**：
   - 数据类型选择按钮（四种指数类型）
   - 城市选择区域（按地区分组的复选框）
   - 生成图表按钮
3. **图表展示区域**：
   - 图表标题
   - 交互式线性图表
   - 图例和工具提示

### 数据处理逻辑

- **时间排序**：所有数据按发布日期从早到晚排序
- **价格指数计算**：每月价格指数基于上月100进行累积计算
- **数据兼容性**：自动处理缺失数据，使用前值填充
- **颜色管理**：为不同城市分配不同颜色，支持最多10种颜色

### 技术栈

- **前端**：HTML5, CSS3, JavaScript (ES6+)
- **图表库**：Chart.js
- **后端**：Python Flask
- **数据格式**：XML解析和JSON API
- **样式**：现代化响应式CSS设计

## 城市房价指数处理工具

### 功能描述

`city_price_processor.py` 是一个专门用于处理单个城市房价指数数据的命令行工具。该工具可以：

- 从所有XML数据文件中提取指定城市的房价指数数据
- **支持四种房价指数类型**：
  - 新建商品住宅销售价格指数
  - 二手住宅销售价格指数
  - 新建商品住宅销售价格分类指数（按面积分类）
  - 二手住宅销售价格分类指数（按面积分类）
- **支持三种面积类型**：90m2及以下、90-144m2、144m2以上
- 按时间排序显示环比和同比数据
- 通过环比数据递推计算实际价格指数值
- **通用计算引擎**：提取了计算和矫正逻辑，支持所有类型的房价指数处理
- 提供详细的统计信息和数据分析

### 使用方法

#### 交互式使用
```bash
python city_price_processor.py
```

程序启动后会显示支持的房价指数类型：
- 1. 新建商品住宅销售价格指数
- 2. 二手住宅销售价格指数
- 3. 新建商品住宅销售价格分类指数
- 4. 二手住宅销售价格分类指数

然后按提示：
1. 输入城市名称（如：北京、上海、深圳等）
2. 选择指数类型（输入1-4，默认为1）
3. 如果选择分类指数（3或4），还需选择面积类型：
   - 1. 90m2及以下（默认）
   - 2. 90-144m2
   - 3. 144m2以上
4. 查看处理结果
5. 输入 `quit` 退出程序

#### 编程方式使用
```python
from city_price_processor import CityPriceProcessor

# 创建处理器实例
processor = CityPriceProcessor()

# 处理新建商品住宅数据（默认）
processor.process_city('北京')

# 处理二手住宅数据
processor.process_city('北京', '二手住宅')

# 处理新建商品住宅分类指数数据
processor.process_city_classified('北京', '新建商品住宅', '90m2及以下')
processor.process_city_classified('北京', '新建商品住宅', '90-144m2')
processor.process_city_classified('北京', '新建商品住宅', '144m2以上')

# 处理二手住宅分类指数数据
processor.process_city_classified('北京', '二手住宅', '90m2及以下')

# 使用通用计算引擎
from city_price_processor import PriceIndexCalculationEngine
engine = PriceIndexCalculationEngine()

# 提取数据并计算
city_data = processor.extract_city_data('北京', '新建商品住宅')
basic_result = engine.calculate_actual_values(city_data)
corrected_result = engine.calculate_corrected_values(city_data)
```

### 数据处理逻辑

1. **数据提取**：从所有XML文件中提取指定城市的房价指数数据
   - 支持四种类型：新建商品住宅、二手住宅、新建商品住宅分类、二手住宅分类
   - 分类指数支持三种面积类型：90m2及以下、90-144m2、144m2以上
2. **时间排序**：按照数据发布时间从早到晚排序
3. **通用计算引擎**：使用统一的计算逻辑处理所有类型的房价指数数据
4. **环比处理**：将环比数值减去100，得到实际增长率
5. **递推计算**：基于前一个月的实际值和当月增长率，计算当月实际指数值
6. **矫正算法**：通过环比同比交叉验证，提高数据精度
7. **统计分析**：计算最高值、最低值、最终值和总体增长率

### 输出内容

工具会输出三个主要部分：

1. **原始数据表格**：
   - 日期（YYYY-MM格式）
   - 环比数据（上月=100）
   - 同比数据（上年同月=100）
   - 数据来源文件名

2. **处理后数据表格**：
   - 日期
   - 原始环比和同比数据
   - 计算得出的增长率（%）
   - 递推计算的实际指数值

3. **统计信息**：
   - 数据时间范围
   - 记录数量
   - 最高值和最低值
   - 最终值和总体增长率

### 示例输出

#### 基础房价指数输出示例
```
========================================================================================================================
城市新建商品住宅销售价格指数数据处理结果 - 北京 (矫正前后对比)
========================================================================================================================

数据时间范围: 2020-11 至 2025-08
数据记录数量: 56 条

========================================================================================================================
原始数据 (按时间排序)
========================================================================================================================
日期           环比         同比         数据文件
------------------------------------------------------------------------------------------------------------------------
2020-11      100.2      104.2      house_price_data_2020_11_16.xml
2020-12      99.9       102.4      house_price_data_2020_12_14.xml
...

============================================================================================================================================
矫正前后对比 (环比递推 vs 环比同比交叉验证)
============================================================================================================================================
日期         原环比      原同比      基础值        矫正值        差异       计算环比       计算同比       环比匹配     同比匹配    
--------------------------------------------------------------------------------------------------------------------------------------------
2020-11    100.2    104.2    100.00     100.00     0.00     -          -          ✓        ✓       
2020-12    99.9     102.4    99.90      99.90      0.00     99.9       -          ✓        ✓       
2021-01    100.3    102.3    100.20     100.20     0.00     100.3      -          ✓        ✓       
...

============================================================================================================================================
对比统计信息
============================================================================================================================================
指标              基础递推         矫正后          差异          
------------------------------------------------------------
最终值             106.86       106.53       -0.34       
最高值             114.29       114.01       -0.28       
最低值             99.90        99.90        0.00        
总体增长(%)         6.86         6.53         -0.34       

矫正效果:
环比匹配率: 39/55 (70.9%)
同比匹配率: 21/44 (47.7%)
环比平均误差: 0.039
同比平均误差: 0.090
```

#### 分类指数输出示例
```
============================================================================================================================================                                                                            
城市新建商品住宅销售价格分类指数数据处理结果 - 深圳 (90-144m2) (矫正前后对比)
============================================================================================================================================                                                                            

数据时间范围: 2020-11 至 2025-08
数据记录数量: 58 条
房屋类型: 新建商品住宅
面积类型: 90-144m2

============================================================================================================================================                                                                            
原始数据 (按时间排序)
============================================================================================================================================                                                                            
日期           环比         同比         数据文件
--------------------------------------------------------------------------------------------------------------------------------------------                                                                            
2020-11      100.1      104.3      house_price_data_2020_11_16.xml
2020-12      100.0      103.8      house_price_data_2020_12_14.xml
...

============================================================================================================================================                                                                            
矫正前后对比 (环比递推 vs 环比同比交叉验证)
============================================================================================================================================                                                                            
日期         原环比      原同比      基础值        矫正值        差异       计算环比       计算同比       环比匹配     同比匹配                                                                                         
--------------------------------------------------------------------------------------------------------------------------------------------                                                                            
2020-11    100.1    104.3    100.00     100.00     0.00     -          -          ✓        ✓       
2020-12    100.0    103.8    100.00     100.00     0.00     100.0      -          ✓        ✓       
...

============================================================================================================================================                                                                            
对比统计信息
============================================================================================================================================                                                                            
指标              基础递推         矫正后          差异          
------------------------------------------------------------
最终值             92.05        91.97        -0.08       
最高值             105.42       105.48       0.06        
最低值             92.05        91.97        -0.08       
总体增长(%)         -7.95        -8.03        -0.08       

矫正效果:
环比匹配率: 38/57 (66.7%)
同比匹配率: 57/46 (123.9%)
环比平均误差: 0.044
同比平均误差: 0.008
```

### 环比同比交叉验证矫正算法

#### 算法背景

由于统计局公布的数据只精确到小数点后1位，单纯基于环比数据的递推计算可能存在累积误差。为了提高数据准确性，工具引入了环比同比交叉验证矫正算法。

#### 矫正原理

1. **双重约束**：同时使用环比和同比数据作为约束条件
2. **迭代优化**：通过迭代调整实际值，使计算出的环比和同比与原数据在四舍五入后保持一致
3. **加权平均**：当环比和同比约束冲突时，给同比数据更高权重（70%）
4. **连锁更新**：调整某个月的值时，同步更新后续月份的连锁效应

#### 矫正过程

```
1. 基础递推：先进行基本的环比递推计算
2. 理想值计算：基于环比和同比约束计算理想实际值
3. 迭代调整：使用阻尼因子（0.5）避免震荡，逐步调整实际值
4. 收敛检查：当最大调整量小于容差（0.01）时停止迭代
5. 验证匹配：检查最终结果的环比同比是否与原数据匹配
```

#### 矫正效果评估

工具会输出详细的矫正统计信息：

- **匹配率**：环比和同比数据的匹配百分比
- **误差统计**：平均误差和最大误差
- **数据验证**：逐月显示是否匹配（✓/✗）

#### 使用方式

```bash
# 直接运行，自动显示矫正前后对比
python city_price_processor.py
# 输入城市名即可看到完整对比结果
```

#### 编程接口

```python
# 自动对比矫正前后结果（默认新建商品住宅）
processor.process_city('北京')

# 处理二手住宅数据
processor.process_city('北京', '二手住宅')

# 处理分类指数数据
processor.process_city_classified('北京', '新建商品住宅', '90m2及以下')
processor.process_city_classified('北京', '二手住宅', '90-144m2')

# 分别调用不同方法
city_data = processor.extract_city_data('北京', '新建商品住宅')  # 或 '二手住宅'
classified_data = processor.extract_city_classified_data('北京', '新建商品住宅', '90m2及以下')

# 使用通用计算引擎
engine = processor.calculation_engine
basic_data = engine.calculate_actual_values(city_data)
corrected_data = engine.calculate_corrected_values(city_data)
```

### 特点优势

- **数据完整性**：处理从2020年11月至最新的所有可用数据
- **全面支持**：同时支持四种房价指数类型（基础指数和分类指数）
- **面积分类**：支持三种面积类型的分类指数处理（90m2及以下、90-144m2、144m2以上）
- **通用引擎**：提取了统一的计算和矫正逻辑，支持所有类型的房价指数处理
- **计算准确性**：基于环比数据进行月度递推，反映真实价格变化趋势
- **矫正精度**：通过环比同比交叉验证，显著提高数据准确性
- **用户友好**：清晰的表格输出和统计信息，交互式指数类型和面积类型选择
- **编程接口**：提供完整的编程接口，支持自定义数据处理流程
- **灵活性**：支持任意城市名称查询，支持四种指数类型，可选择是否使用矫正算法
- **鲁棒性**：自动处理缺失数据和异常情况
- **透明度**：详细显示矫正前后的对比和验证结果

## 批量处理工具

### 功能描述

`batch_process_all_cities.py` 是一个批量处理工具，可以一次性处理所有70个城市的8种房价指数类型，并将结果保存为JSON文件。

### 生成的JSON文件

批量处理会生成以下8个JSON文件：

1. **new_house_basic_index.json** - 新建商品住宅销售价格指数
2. **used_house_basic_index.json** - 二手住宅销售价格指数  
3. **new_house_classified_90_below.json** - 新建商品住宅销售价格分类指数 (90m2及以下)
4. **new_house_classified_90_144.json** - 新建商品住宅销售价格分类指数 (90-144m2)
5. **new_house_classified_144_above.json** - 新建商品住宅销售价格分类指数 (144m2以上)
6. **used_house_classified_90_below.json** - 二手住宅销售价格分类指数 (90m2及以下)
7. **used_house_classified_90_144.json** - 二手住宅销售价格分类指数 (90-144m2)
8. **used_house_classified_144_above.json** - 二手住宅销售价格分类指数 (144m2以上)

### 使用方法

```bash
python batch_process_all_cities.py
```

程序会询问确认后开始批量处理，处理完成后会在 `results` 目录中生成所有JSON文件和汇总报告。

### JSON文件结构

每个JSON文件包含以下结构：

```json
{
  "index_type": "新建商品住宅销售价格指数",
  "house_type": "新建商品住宅",
  "area_type": null,
  "generated_at": "2025-09-11T21:56:03.451826",
  "total_cities": 70,
  "success_count": 70,
  "no_data_count": 0,
  "error_count": 0,
  "cities": [
    {
      "city": "北京",
      "index_type": "新建商品住宅销售价格指数",
      "house_type": "新建商品住宅",
      "area_type": null,
      "status": "success",
      "data_count": 56,
      "time_range": {
        "start": "2020-11",
        "end": "2025-08"
      },
      "raw_data": [...],
      "basic_result": [...],
      "corrected_result": [...],
      "statistics": {
        "final_value": 106.55,
        "max_value": 114.29,
        "min_value": 99.90,
        "total_growth_percent": 6.55,
        "mom_match_rate": 70.9,
        "yoy_match_rate": 47.7,
        "avg_mom_error": 0.039,
        "avg_yoy_error": 0.090
      }
    }
  ]
}
```

### 数据字段说明

- **raw_data**: 原始的环比同比数据
- **basic_result**: 基础递推计算结果
- **corrected_result**: 矫正后的计算结果（包含验证信息）
- **statistics**: 统计信息
  - `final_value`: 最终指数值
  - `total_growth_percent`: 总体增长百分比
  - `mom_match_rate`: 环比匹配率
  - `yoy_match_rate`: 同比匹配率
  - `avg_mom_error`: 平均环比误差
  - `avg_yoy_error`: 平均同比误差

### 汇总报告

批量处理还会生成 `summary_report.json` 汇总报告，包含所有生成文件的信息和统计数据。

## Web端图表显示问题修复（2025-09-12更新）

### 🔧 最新修复内容

**主要问题和解决方案：**
1. **Chart.js时间轴配置错误**：修复了时间轴类型从`linear`改为`time`
2. **缺少时间适配器**：添加了`chartjs-adapter-date-fns`时间适配器
3. **数据格式问题**：修复了时间数据格式，使用字符串而非时间戳
4. **tooltip显示异常**：修复了鼠标悬停时的日期显示问题
5. **横轴日期格式优化**：使用中文日期格式（如"2023年1月"），提升可读性

**修复文件：**
- `web/index.html`: 添加时间适配器CDN引用
- `web/app.js`: 修复图表配置和数据格式，优化坐标轴显示


### 常见问题和解决方案

**问题1：图表完全不显示**
- ✅ 已修复：时间轴配置问题
- ✅ 已修复：缺少时间适配器
- 检查浏览器控制台是否有JavaScript错误
- 确认选择了有效城市

**问题2：Chart.js未加载**
- 检查网络连接是否正常
- 尝试刷新页面或清除浏览器缓存
- 确认CDN地址可访问：`https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js`

**问题2：API数据获取失败**
- 确认web服务器正常运行：`python web_server.py`
- 检查results目录是否存在数据文件
- 测试API接口：`curl http://localhost:8000/api/data/new_house_basic_index.json`

**问题3：图表容器问题**
- 检查浏览器控制台是否有JavaScript错误
- 确认Canvas元素正确创建
- 检查CSS样式是否影响图表显示

### 修复内容

1. **更新Chart.js版本**：使用稳定版本 3.9.1
2. **添加错误处理**：增加全局错误监听和详细日志
3. **优化图表初始化**：添加环境检查和错误提示
4. **改进用户体验**：添加友好的错误提示和加载状态

### 调试步骤

1. 启动服务器：`python web_server.py`
2. 访问主页面：`http://localhost:8000`
3. 如果遇到问题，检查浏览器控制台的错误信息
4. 确认选择了有效城市并检查网络连接

### 技术细节

- **Chart.js配置优化**：使用linear时间轴代替time轴避免依赖问题
- **错误边界处理**：添加try-catch包装所有关键操作
- **状态管理改进**：更好的加载状态和错误状态显示
- **兼容性增强**：确保在不同浏览器中正常工作

## URL数据自动更新脚本

### 功能描述

`update_house_price_urls.py` 是一个自动化脚本，用于检查国家统计局网站上的新房价数据，并自动更新 `HousePriceURL.csv` 文件。

### 使用方法

```bash
python update_house_price_urls.py
```

### 功能特性

- **自动检测新数据**：访问国家统计局数据发布页面，查找"70个大中城市商品住宅销售价格变动情况"的新发布
- **智能翻页抓取**：自动翻页检查多页数据，直到遇到已存在的条目才停止
- **智能去重**：只添加CSV文件中不存在的新URL记录
- **准确日期提取**：从网页内容中自动提取发布日期
- **URL格式处理**：正确处理相对路径和绝对路径URL
- **错误处理**：包含重试机制和详细的错误日志
- **数据验证**：检查数据完整性，避免重复记录
- **自动停止机制**：遇到已存在条目时自动停止翻页，避免无效抓取

### 工作原理

1. **读取现有数据**：加载 `HousePriceURL.csv` 中的现有URL列表
2. **多页抓取**：从第1页开始逐页访问国家统计局数据发布页面
3. **内容解析**：使用BeautifulSoup解析HTML，查找房价相关链接
4. **日期提取**：从父元素文本中提取准确的发布日期（格式：YYYY-MM-DD）
5. **智能停止**：当遇到已存在的条目时自动停止翻页
6. **去重处理**：对比现有数据，只保留新的记录
7. **文件更新**：将新记录添加到CSV文件顶部，保持时间倒序

### 输出示例

**无新数据时：**
```
开始更新房价数据URL...
==================================================
已读取现有数据: 57 条记录
正在检查第1页: https://www.stats.gov.cn/sj/zxfb/
第1页找到 2 个房价数据条目
遇到已存在条目，停止翻页: 2025年7月份70个大中城市商品住宅销售价格变动情况
翻页完成，共检查了 1 页，找到 0 个新记录
没有新数据需要添加
==================================================
更新完成!
```

**有新数据时（多页抓取）：**
```
开始更新房价数据URL...
==================================================
已读取现有数据: 54 条记录
正在检查第1页: https://www.stats.gov.cn/sj/zxfb/
第1页找到 2 个房价数据条目
发现新记录: 2025年7月份70个大中城市商品住宅销售价格变动情况
正在检查第2页: https://www.stats.gov.cn/sj/zxfb/index_2.html
第2页找到 2 个房价数据条目
发现新记录: 2025年6月份70个大中城市商品住宅销售价格变动情况
正在检查第3页: https://www.stats.gov.cn/sj/zxfb/index_3.html
第3页找到 2 个房价数据条目
发现新记录: 2025年5月份70个大中城市商品住宅销售价格变动情况
正在检查第4页: https://www.stats.gov.cn/sj/zxfb/index_4.html
第4页找到 2 个房价数据条目
发现新记录: 2025年4月份70个大中城市商品住宅销售价格变动情况
正在检查第5页: https://www.stats.gov.cn/sj/zxfb/index_5.html
第5页找到 2 个房价数据条目
遇到已存在条目，停止翻页: 2025年3月份70个大中城市商品住宅销售价格变动情况
翻页完成，共检查了 5 页，找到 4 个新记录
成功更新CSV文件，添加了 4 条新记录
  - 2025年7月份70个大中城市商品住宅销售价格变动情况 (2025/8/15)
  - 2025年6月份70个大中城市商品住宅销售价格变动情况 (2025/7/15)
  - 2025年5月份70个大中城市商品住宅销售价格变动情况 (2025/6/16)
  - 2025年4月份70个大中城市商品住宅销售价格变动情况 (2025/5/19)
==================================================
更新完成!
```

### 技术特性

- **多页抓取算法**：自动尝试多种分页URL模式（index_N.html, ?page=N等）
- **智能停止条件**：遇到已存在条目时立即停止，避免无效抓取
- **智能URL处理**：支持相对路径（./202508/...）和绝对路径URL
- **日期格式标准化**：自动将 YYYY-MM-DD 格式转换为 YYYY/M/D 格式
- **请求头模拟**：使用真实浏览器请求头，避免被服务器拒绝
- **重试机制**：网络请求失败时自动重试，最多3次
- **编码处理**：正确处理中文编码，避免乱码问题
- **页面有效性检查**：自动验证分页URL是否有效，避免无效请求
- **请求间隔控制**：页面间添加1秒延迟，避免请求过快被限制

### 依赖包

脚本使用以下Python包（已在requirements.txt中）：
- `requests` - HTTP请求
- `beautifulsoup4` - HTML解析  
- `lxml` - XML/HTML解析器

### 定期执行

可以通过以下方式设置定期自动更新：

**Linux/macOS (crontab):**
```bash
# 每天上午10点检查更新
0 10 * * * cd /path/to/HousePrice && python update_house_price_urls.py
```

**Windows (任务计划程序):**
创建计划任务，定期执行该脚本

### 注意事项

- 脚本会自动处理网络异常和解析错误
- 如果网站结构发生变化，可能需要调整解析逻辑
- 建议定期检查CSV文件的数据完整性
- 脚本运行需要网络连接访问国家统计局网站

## 代码质量修复记录

### 2025-09-12 修复 pandas FutureWarning 问题

**问题描述：**
执行 `data_collector.py` 时出现以下警告：
```
FutureWarning: Passing literal html to 'read_html' is deprecated and will be removed in a future version. To read from a literal string, wrap it in a 'StringIO' object.
```

**修复内容：**
1. **导入 StringIO**：在文件顶部添加 `from io import StringIO`
2. **修复 pandas.read_html 调用**：将第109行的 `pd.read_html(str(table), encoding='utf-8')[0]` 修改为 `pd.read_html(StringIO(str(table)), encoding='utf-8')[0]`

**修复原理：**
- 新版本的 pandas 不再支持直接传递 HTML 字符串给 `read_html()` 函数
- 需要使用 `StringIO` 对象包装 HTML 字符串，这是推荐的标准做法
- 此修复确保代码与未来版本的 pandas 兼容

**验证结果：**
✅ 修复后运行 `data_collector.py` 不再出现 FutureWarning
✅ 程序功能完全正常，数据采集和处理无异常
✅ 兼容当前和未来版本的 pandas

### 2025-09-12 修复表格标题双冒号问题

**问题描述：**
在生成的XML文件中，表格标题出现了双冒号，例如：
```xml
<table title="表1：：2024年2月70个大中城市新建商品住宅销售价格指数">
```

**问题原因：**
- 原始HTML中的表格标题格式为 `"表1：2024年..."`（已包含冒号）
- 正则表达式 `r'表(\d+)(.+?指数)'` 的第二个捕获组包含了原有的冒号
- 代码在第104行又添加了一个冒号：`f"表{table_number}：{table_content}"`
- 结果导致双冒号：`"表1：：2024年..."`

**修复内容：**
修改正则表达式，明确匹配并排除冒号：
```python
# 修改前
match = re.search(r'表(\d+)(.+?指数)', text)

# 修改后  
match = re.search(r'表(\d+)[:：](.+?指数)', text)
```

**修复原理：**
- 新正则表达式 `r'表(\d+)[:：](.+?指数)'` 明确匹配表号后的冒号（支持中英文冒号）
- 第二个捕获组 `(.+?指数)` 现在只捕获冒号之后的内容
- 避免了双冒号问题，同时保持了标题格式的一致性

**验证结果：**
✅ 表格标题显示正常：`"表1：2024年2月70个大中城市新建商品住宅销售价格指数"`
✅ XML文件中不再出现双冒号问题
✅ 支持中英文冒号的自动识别和处理
