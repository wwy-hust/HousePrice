<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图表调试页面</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-container {
            width: 800px;
            height: 400px;
            margin: 20px auto;
        }
        #log {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        select {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>房价图表调试页面</h1>
    
    <div class="debug-section">
        <h2>测试控制</h2>
        <select id="citySelect">
            <option value="">请选择城市...</option>
            <option value="北京">北京</option>
            <option value="上海">上海</option>
            <option value="深圳">深圳</option>
            <option value="广州">广州</option>
        </select>
        <button onclick="testAPI()">测试API</button>
        <button onclick="testChart()">测试图表</button>
        <button onclick="clearLog()">清空日志</button>
    </div>
    
    <div class="debug-section">
        <h2>调试日志</h2>
        <div id="log"></div>
    </div>
    
    <div class="debug-section">
        <h2>图表测试</h2>
        <div class="chart-container">
            <canvas id="testChart"></canvas>
        </div>
    </div>

    <script>
        let chart = null;
        const log = document.getElementById('log');
        
        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            log.textContent = '';
        }
        
        // 检查Chart.js
        if (typeof Chart === 'undefined') {
            addLog('错误: Chart.js未加载!');
        } else {
            addLog(`Chart.js加载成功，版本: ${Chart.version || 'unknown'}`);
        }
        
        // 测试API
        async function testAPI() {
            const citySelect = document.getElementById('citySelect');
            const city = citySelect.value;
            
            if (!city) {
                addLog('请选择城市');
                return;
            }
            
            addLog(`开始测试API: ${city}`);
            
            try {
                const url = `/api/city/${encodeURIComponent(city)}/new_house_basic`;
                addLog(`请求URL: ${url}`);
                
                const response = await fetch(url);
                addLog(`响应状态: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                addLog(`数据获取成功:`);
                addLog(`- 城市: ${data.city_data?.city || 'N/A'}`);
                addLog(`- 状态: ${data.city_data?.status || 'N/A'}`);
                addLog(`- 数据点数量: ${data.city_data?.data_count || 'N/A'}`);
                addLog(`- 原始数据长度: ${data.city_data?.raw_data?.length || 'N/A'}`);
                addLog(`- 矫正数据长度: ${data.city_data?.corrected_result?.length || 'N/A'}`);
                
                if (data.city_data?.corrected_result?.length > 0) {
                    const sample = data.city_data.corrected_result[0];
                    addLog(`- 矫正数据样本: ${JSON.stringify(sample)}`);
                }
                
            } catch (error) {
                addLog(`API测试失败: ${error.message}`);
            }
        }
        
        // 测试图表
        async function testChart() {
            const citySelect = document.getElementById('citySelect');
            const city = citySelect.value;
            
            if (!city) {
                addLog('请选择城市');
                return;
            }
            
            addLog(`开始测试图表: ${city}`);
            
            try {
                // 获取数据
                const response = await fetch(`/api/city/${encodeURIComponent(city)}/new_house_basic`);
                const data = await response.json();
                
                if (!data.city_data || data.city_data.status !== 'success') {
                    addLog('数据无效');
                    return;
                }
                
                const cityData = data.city_data;
                const sourceData = cityData.corrected_result || cityData.raw_data;
                
                if (!sourceData || sourceData.length === 0) {
                    addLog('没有可用数据');
                    return;
                }
                
                addLog(`使用数据源: ${cityData.corrected_result ? 'corrected_result' : 'raw_data'}`);
                addLog(`数据点数量: ${sourceData.length}`);
                
                // 准备图表数据
                const sortedData = sourceData.sort((a, b) => {
                    return new Date(a.date + '-01') - new Date(b.date + '-01');
                });
                
                const chartData = sortedData.map(item => ({
                    x: item.date + '-01',
                    y: item.actual_value || item.month_on_month || 100
                }));
                
                addLog(`图表数据准备完成，数据点: ${chartData.length}`);
                addLog(`数据范围: ${chartData[0]?.y} - ${chartData[chartData.length-1]?.y}`);
                
                // 销毁旧图表
                if (chart) {
                    chart.destroy();
                }
                
                // 创建新图表
                const canvas = document.getElementById('testChart');
                const ctx = canvas.getContext('2d');
                
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: '房价指数',
                            data: chartData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            fill: false,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${city} 房价指数`
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month',
                                    displayFormats: {
                                        month: 'yyyy年M月'
                                    }
                                },
                                title: {
                                    display: true,
                                    text: '时间'
                                },
                                ticks: {
                                    maxTicksLimit: 12,
                                    callback: function(value, index, values) {
                                        const date = new Date(value);
                                        return `${date.getFullYear()}年${date.getMonth() + 1}月`;
                                    }
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '指数'
                                }
                            }
                        }
                    }
                });
                
                addLog('图表创建成功!');
                
            } catch (error) {
                addLog(`图表测试失败: ${error.message}`);
                addLog(`错误堆栈: ${error.stack}`);
            }
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLog('调试页面加载完成');
        });
    </script>
</body>
</html>