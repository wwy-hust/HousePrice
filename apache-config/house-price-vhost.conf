# Apache虚拟主机配置 - 房价数据可视化系统
# 这个配置将整个应用通过Apache提供服务，需要配置mod_wsgi

<VirtualHost *:80>
    ServerName your-domain.com
    # ServerAlias www.your-domain.com
    
    DocumentRoot /Users/wangwenye/Github/HousePrice/web
    
    # Python应用配置
    WSGIDaemonProcess house-price python-home=/Users/wangwenye/Github/HousePrice python-path=/Users/wangwenye/Github/HousePrice
    WSGIProcessGroup house-price
    WSGIScriptAlias /api /Users/wangwenye/Github/HousePrice/apache-config/house-price.wsgi
    
    # 静态文件配置
    <Directory "/Users/wangwenye/Github/HousePrice/web">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # 缓存静态资源
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|woff|woff2|ttf|svg)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
            Header append Cache-Control "public"
        </FilesMatch>
        
        # HTML文件缓存较短时间
        <FilesMatch "\.html$">
            ExpiresActive On
            ExpiresDefault "access plus 1 hour"
        </FilesMatch>
    </Directory>
    
    # WSGI配置目录权限
    <Directory "/Users/wangwenye/Github/HousePrice/apache-config">
        WSGIApplicationGroup %{GLOBAL}
        Require all granted
    </Directory>
    
    # 数据文件目录（只允许通过API访问）
    <Directory "/Users/wangwenye/Github/HousePrice/results">
        Require all denied
    </Directory>
    
    # 源代码目录保护
    <Directory "/Users/wangwenye/Github/HousePrice">
        <Files "*.py">
            Require all denied
        </Files>
        <Files "*.pyc">
            Require all denied
        </Files>
    </Directory>
    
    # 日志配置
    ErrorLog ${APACHE_LOG_DIR}/house-price-error.log
    CustomLog ${APACHE_LOG_DIR}/house-price-access.log combined
    LogLevel info
    
    # 安全头设置
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # 压缩配置
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
</VirtualHost>

# HTTPS配置
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName your-domain.com
    # ServerAlias www.your-domain.com
    
    DocumentRoot /Users/wangwenye/Github/HousePrice/web
    
    # SSL配置
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # SSLCertificateChainFile /path/to/your/chain.crt
    
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    Header always set Strict-Transport-Security "max-age=63072000"
    
    # Python应用配置
    WSGIDaemonProcess house-price-ssl python-home=/Users/wangwenye/Github/HousePrice python-path=/Users/wangwenye/Github/HousePrice
    WSGIProcessGroup house-price-ssl
    WSGIScriptAlias /api /Users/wangwenye/Github/HousePrice/apache-config/house-price.wsgi
    
    # 其他配置与HTTP版本相同
    <Directory "/Users/wangwenye/Github/HousePrice/web">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|woff|woff2|ttf|svg)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
            Header append Cache-Control "public"
        </FilesMatch>
        
        <FilesMatch "\.html$">
            ExpiresActive On
            ExpiresDefault "access plus 1 hour"
        </FilesMatch>
    </Directory>
    
    <Directory "/Users/wangwenye/Github/HousePrice/apache-config">
        WSGIApplicationGroup %{GLOBAL}
        Require all granted
    </Directory>
    
    <Directory "/Users/wangwenye/Github/HousePrice/results">
        Require all denied
    </Directory>
    
    <Directory "/Users/wangwenye/Github/HousePrice">
        <Files "*.py">
            Require all denied
        </Files>
        <Files "*.pyc">
            Require all denied
        </Files>
    </Directory>
    
    ErrorLog ${APACHE_LOG_DIR}/house-price-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/house-price-ssl-access.log combined
    
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
</VirtualHost>
</IfModule>
