# Apache反向代理配置 - 房价数据可视化系统
# 适用于将Python web_server.py作为后端服务运行，Apache作为反向代理

<VirtualHost *:80>
    ServerName wenye.wang
    # ServerAlias www.your-domain.com  # 可选的别名
    
    DocumentRoot /Users/wangwenye/Github/HousePrice/web
    
    # 启用代理模块
    ProxyPreserveHost On
    ProxyRequests Off
    
    # 静态文件直接由Apache提供服务（性能更好）
    <Directory "/Users/wangwenye/Github/HousePrice/web">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        # 缓存静态资源
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|woff|woff2|ttf|svg)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
            Header append Cache-Control "public"
        </FilesMatch>
        
        # HTML文件缓存较短时间
        <FilesMatch "\.html$">
            ExpiresActive On
            ExpiresDefault "access plus 1 hour"
        </FilesMatch>
    </Directory>
    
    # API请求代理到Python后端
    ProxyPass /api/ http://127.0.0.1:8000/api/
    ProxyPassReverse /api/ http://127.0.0.1:8000/api/
    
    # 设置代理超时
    ProxyTimeout 300
    
    # 日志配置
    ErrorLog ${APACHE_LOG_DIR}/house-price-error.log
    CustomLog ${APACHE_LOG_DIR}/house-price-access.log combined
    LogLevel info
    
    # 安全头设置
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # 压缩配置
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
</VirtualHost>

# HTTPS配置（推荐生产环境使用）
<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName wenye.wang
    # ServerAlias www.your-domain.com
    
    DocumentRoot /Users/wangwenye/Github/HousePrice/web
    
    # SSL配置
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    # SSLCertificateChainFile /path/to/your/chain.crt  # 如果有证书链
    
    # 现代SSL配置
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off
    
    # HSTS (可选)
    Header always set Strict-Transport-Security "max-age=63072000"
    
    # 其他配置与HTTP版本相同
    ProxyPreserveHost On
    ProxyRequests Off
    
    <Directory "/Users/wangwenye/Github/HousePrice/web">
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
        
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|woff|woff2|ttf|svg)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 month"
            Header append Cache-Control "public"
        </FilesMatch>
        
        <FilesMatch "\.html$">
            ExpiresActive On
            ExpiresDefault "access plus 1 hour"
        </FilesMatch>
    </Directory>
    
    ProxyPass /api/ http://127.0.0.1:8000/api/
    ProxyPassReverse /api/ http://127.0.0.1:8000/api/
    ProxyTimeout 300
    
    ErrorLog ${APACHE_LOG_DIR}/house-price-ssl-error.log
    CustomLog ${APACHE_LOG_DIR}/house-price-ssl-access.log combined
    
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    <Location />
        SetOutputFilter DEFLATE
        SetEnvIfNoCase Request_URI \
            \.(?:gif|jpe?g|png)$ no-gzip dont-vary
        SetEnvIfNoCase Request_URI \
            \.(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
    </Location>
</VirtualHost>
</IfModule>

# HTTP到HTTPS重定向（如果使用HTTPS）
<VirtualHost *:80>
    ServerName your-domain.com
    # ServerAlias www.your-domain.com
    
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>
